# Docker Compose configuration for running E2E tests
# Usage: docker-compose -f docker-compose.test.yml up --build --abort-on-container-exit
#
# NOTE: E2E tests require Clerk authentication.
# You must provide valid CLERK_PUBLISHABLE_KEY and CLERK_SECRET_KEY.
# Tests need to be updated to work with Clerk test users.

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    # Ports not exposed externally - only internal Docker network needed
    expose:
      - "3001"
    environment:
      - PORT=3001
      - NODE_ENV=test
      - FRONTEND_URL=http://frontend:5173
      - CLERK_SECRET_KEY=${CLERK_SECRET_KEY}
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3001/health"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile.dev
    # Ports not exposed externally - only internal Docker network needed
    expose:
      - "5173"
    environment:
      - VITE_API_URL=http://backend:3001
      - VITE_CLERK_PUBLISHABLE_KEY=${VITE_CLERK_PUBLISHABLE_KEY}
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:5173"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 15s

  tests:
    build:
      context: ./tests
      dockerfile: Dockerfile
    environment:
      - BASE_URL=http://frontend:5173
      - API_URL=http://backend:3001
      - HEADLESS=true
    depends_on:
      frontend:
        condition: service_healthy
      backend:
        condition: service_healthy
    volumes:
      - ./tests/screenshots:/app/tests/screenshots
    shm_size: '2gb'
    # Default: smoke tests. For full suite: docker-compose -f docker-compose.test.yml run tests npm test
    command: ["npm", "test", "--", "--testPathPattern=smoke"]
