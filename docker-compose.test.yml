# Docker Compose configuration for running E2E tests
# Usage: docker-compose -f docker-compose.test.yml up --build --abort-on-container-exit

version: '3.8'

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    ports:
      - "3001:3001"
    environment:
      - PORT=3001
      - NODE_ENV=test
      - DEV_MODE=true
    volumes:
      - ./backend/src:/app/src:ro
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3001/health"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    ports:
      - "5173:5173"
    environment:
      - VITE_API_URL=http://backend:3001
      - VITE_DEV_MODE=true
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:5173"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 15s

  tests:
    build:
      context: ./tests
      dockerfile: Dockerfile
    environment:
      - BASE_URL=http://frontend:5173
      - API_URL=http://backend:3001
      - HEADLESS=true
    depends_on:
      frontend:
        condition: service_healthy
      backend:
        condition: service_healthy
    volumes:
      - ./tests/screenshots:/app/tests/screenshots
    shm_size: '2gb'
